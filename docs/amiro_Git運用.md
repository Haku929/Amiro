# Amiro 開発：Git 運用・コードレビュー

共同開発でぶれないようにするための Git の使い方と GitHub Issue・PR・コードレビューのルールです。タスクやバグは Issue で管理し、PR で紐付けて閉じる。

---

## 1. Git の基本フロー

* **main は常に動作が保証されている**。ビルドが通り、起動し、主要なフローが動く状態を維持する。壊れている変更は main にマージしない。
* 開発は **GitHub Issue** でタスク・バグを起票し、**main から分岐したブランチ** で作業して **PR** で main に取り込む。PR マージ時に紐付けた Issue は自動で閉じる。
* main への直接 push は行わない。
* 作業開始時は、担当する Issue を決め、最新の main を取り込んでからブランチを切る。

```text
Issue #1 ──► feature/xxx ── PR (Closes #1) ──► main
Issue #2 ──► feature/yyy ── PR (Closes #2) ──► main
```

**よく使うコマンド**

| 目的 | コマンド例 |
| --- | --- |
| main を最新にする | `git checkout main && git pull origin main` |
| 作業ブランチを作る | `git checkout -b feature/担当名-機能の短い名前` |
| 変更をローカルに保存 | `git add .` → `git commit -m "prefix: メッセージ"` |
| リモートに送る | `git push origin ブランチ名` |
| main の変更を取り込む | `git checkout 自分のブランチ` → `git merge main` または `git rebase main` |

### 環境変数ファイル

* **`.env` および `.env.local` など実際の値を含むファイルは Git にコミットしない**。`.gitignore` に含める。
* **`.env.example`** をリポジトリに含める。記載するのは **変数名と説明のみ**。値は空またはプレースホルダー（例: `SUPABASE_URL=` や `GEMINI_API_KEY=your_key_here`）。新しく環境変数が必要になった変更は、その PR で `.env.example` を更新する。
* 初回クローン後は `.env.example` をコピーして `.env` を作成し、各自で値を設定する。値の共有はチャットや共有ストレージなど、リポジトリ外で行う。

---

## 2. GitHub Issue の使い方

* **タスク（機能・画面・API）やバグ**は GitHub Issue で起票する。何をするかが分かれば、細かく分割しなくてもよい。
* **タイトル**は分かりやすく。例: `[DB] profiles / slots テーブル作成`、`[フロント] ログイン画面`、`スロット満杯時に 409 を返す`。
* **本文**に、目的・やること・完了条件（任意）を書く。仕様書の TODO から起票する場合は、該当箇所を引用してもよい。
* **担当**が決まっていれば Issue に Assignee を設定する。**Labels**（例: `front` / `backend` / `db` / `bug`）でフィルタしやすくする。
* 作業する Issue が決まったら、その Issue 用にブランチを切り、PR の本文に **`Closes #番号`**（または `Fixes #番号`）を書く。マージされると Issue が自動で閉じる。
* 1 Issue に対して 1 ブランチ・1 PR を基本とする。大きいタスクは複数 Issue に分けてよい。

---

## 3. ブランチ名のルール

* **種類/担当または機能** の形式。ブランチ名は **ケバブケース**（小文字・単語区切りはハイフン）。スラッシュは `種類/` の 1 本まで。

| 種類 | 例 | 用途 |
| --- | --- | --- |
| **feature/** | `feature/db-schema` / `feature/front-auth` | 新機能・画面・API |
| **fix/** | `fix/slots-409-handling` | バグ修正 |
| **docs/** | `docs/git-workflow` | ドキュメントのみ |
| **chore/** | `chore/deps-update` | 設定・依存関係・ビルド |

担当が分かっている場合は `feature/infra-db-initial` のように **feature/担当-内容** でもよい。

**避けるもの**: 長すぎる名前、スネークケース（アンダースコア）、`test` だけなど中身が分からない名前。

---

## 4. コミットメッセージのルール

* **必ずプレフィックスをつける**（Angular の Conventional Commits に準拠）。
* **本文は 50 文字以内**（プレフィックス含む）。長い説明は PR の本文に書く。
* **日本語**で書く。
* ** imperative（〜する）** の形で書く。句点はつけない。

**形式**: `prefix: メッセージ`

**プレフィックス一覧**

| プレフィックス | 意味 | 例 |
| --- | --- | --- |
| **feat** | 新機能 | `feat: ログイン画面を追加` |
| **fix** | バグ修正 | `fix: スロット満杯時の409を返す` |
| **docs** | ドキュメントのみ | `docs: Git運用を追記` |
| **style** | 見た目・フォーマット（挙動変更なし） | `style: レーダーチャートの凡例を修正` |
| **refactor** | リファクタ（機能追加・バグ修正以外） | `refactor: API クライアントを共通化` |
| **perf** | パフォーマンス改善 | `perf: マッチング一覧のN+1を解消` |
| **test** | テストの追加・修正 | `test: slots API のテストを追加` |
| **chore** | ビルド・設定・依存関係 | `chore: eslint のルールを更新` |

**悪い例**: `更新した`（プレフィックスなし）、`feat: ログイン画面を追加しました。`（句点・「した」は避ける）、長文で 50 文字超過。

---

## 5. PR（Pull Request）の出し方

* **1 PR = 1 つの単位**（1 機能 or 1 修正）にし、大きくなりすぎたらブランチを分ける。
* **タイトル**はコミットと同様に `prefix: 内容` で分かりやすく。日本語可。
* **本文**に以下を書く：
  * 対応する Issue があれば **`Closes #番号`**（または `Fixes #番号`）。マージで Issue が自動で閉じる。
  * 何をしたか（目的・変更内容）
  * なぜそうしたか（必要なら）
  * レビュアーに確認してほしい点（あれば）
  * 動作確認の方法（「〇〇画面で△△して確認」など）
* **main を最新にしたうえで** PR を出す。コンフリクトがあれば解消してからレビュー依頼。
* **PR を出したら、担当者にコードレビューを依頼する**。GitHub の Reviewers 指定やチャットで「レビューお願いします」と伝える。
* レビューが **1 人以上 Approve** されたら main にマージ。マージは **Squash でも Merge でも可**（リポジトリの既定に合わせる）。

---

## 6. コードレビューの仕方

### レビュアーがすること

* **意図と挙動**を読む。仕様書・API スキーマと矛盾していないか。
* **安全さ**：エラーハンドリング、認証・認可（RLS やユーザー識別）が抜けていないか。
* **可読性**：名前やコメントで意図が伝わるか。過度な複雑さがないか。
* **スコープ**：PR の目的から外れた変更が入っていないか。

### コメントのつけ方

* **指摘**：「ここは〇〇にした方がよい（理由）」
* **質問**：「△△の場合はどうなりますか？」
* **良い点**：「この分け方で読みやすい」など、良いところも書くとよい。
* **対象**は「人」ではなく「コード」。敬称はつけず、事実と提案を簡潔に。

### 作者がすること

* 指摘には **理由を聞く・議論する** でよい。納得したら直す、納得しないなら「〇〇の理由でこのままで」と返す。
* 修正したら「対応しました」とコメント。必要なら「再レビューお願いします」。

### レビューが滞ったとき

* 期限（例：翌日まで）を決めておき、過ぎたら「レビューお願いします」とリマインド。緊急時は Slack 等で一声かける。

---

## 7. 運用のまとめ

| 項目 | ルール |
| --- | --- |
| main | 常に動作が保証されている。壊れている変更はマージしない。 |
| 環境変数 | `.env` はコミットしない。`.env.example` に変数名のみ記載し、値を共有するときはリポジトリ外で。 |
| Issue | タスク・バグは Issue で起票。Assignee・Labels で担当と種別を分ける。1 Issue → 1 ブランチ・1 PR。 |
| ブランチ | main から feature/fix/docs/chore で分岐。直接 main に push しない。 |
| ブランチ名 | ケバブケース（小文字・ハイフン）。`feature/担当-内容` など。 |
| コミット | `prefix: 50文字以内の日本語メッセージ`。句点なし。 |
| PR | 1 PR は 1 単位。本文に `Closes #番号` と目的・確認方法を書く。出したら担当者にコードレビューを依頼。1 Approve でマージ可。 |
| コードレビュー | 意図・安全さ・可読性・スコープを見る。コードに対して建設的にコメントする。 |
